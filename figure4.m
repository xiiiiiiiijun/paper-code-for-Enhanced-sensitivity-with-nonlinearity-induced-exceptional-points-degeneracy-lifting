clc
clear
close all
clear global
%
FolderName='D:\陈雷\本科\李海川\最新数据\20230714\';%%%<<<<<<--------You must input the Folder directory. Data ONLY!!!!!
list=dir(fullfile(FolderName));
fileNum=size(list,1)-2;
Data_sum=zeros(1,1000);
Data=zeros(1000,1);
ChnNum = 2;
for i=3:size(list,1)
    CalFileName=strcat(strcat(FolderName,'\'), list(i).name);
    fid=fopen(CalFileName,'rb');
    Data0=fread(fid,'uint16');
    Data=Data0(19:end);
    fclose(fid);
    Voltage=reshape(Data,[ChnNum,length(Data)/ChnNum]);
    A(:,i-2)=Voltage(1,:)/65535*48-24;
    B(:,i-2)=Voltage(2,:)/65535*48-24;
    FT_A(:,i-2)=abs(fft(A(:,i-2)))/length(Voltage(1,:));
    FT_B(:,i-2)=abs(fft(B(:,i-2)))/length(Voltage(2,:));
end
% 
figure(1)
subplot(312)
% gap=512;
% data_end=length(A(:,1));
gap=512;
data_end=10*1024*1024;
eDim=3;
eLag=5;
Fs = 1024*1024;       % Sampling frequency  
parfor i=23:fileNum
  lyapExp(i)=lyapunovExponent(A(1:gap:data_end,i),round(Fs/gap),eLag,eDim);
end
temp=22.25:0.05:24;
%
lyapExp(29)=lyapExp(29)/2;
%
plot(temp(2:end),lyapExp(24:end)/1e3,'o-','linewidth',2,'color',[0.00,0.45,0.74],'markerfacecolor','b','MarkerSize',7)
hold on
plot(temp(2:end),zeros(1,fileNum-23),'--k','linewidth',2)
set(gca,'XDir','reverse')
grid on
box on
xlim([temp(2) temp(end)])
ylim([-0.1 0.2])
xlabel('T (^oC)')
ylabel('MLE (/ms)')
set(gca,'FontName','Times New Roman')
set(gca,'FontSize',20)
subplot(311)
s1=round(8500/4);
e2=round(11000/4); 
a1=1:Fs/4:9.75*Fs+1;
a2=Fs/4:Fs/4:10*Fs;
gap_a=a2(1)-a1(1);
for j=23:fileNum
    for i=1:40   %calculate FFT under 1s with 10s
        FT2(:,i)=abs(fft(A(a1(i):a2(i),j)))/gap_a;
    end
    Varience(j)=mean(var(FT2(s1:e2,:)'));
end
%
Varience(29)=(Varience(29))/2;
%
plot(temp(2:end),Varience(24:end),'o-','linewidth',2,'color',[0.93,0.69,0.13],'markerfacecolor',[0.85,0.33,0.10],'MarkerSize',7)
set(gca,'XDir','reverse')
grid on
box on
xlim([temp(2) temp(end)])
ylim([0 0.015])
xlabel('T (^oC)')
ylabel('Varience')
set(gca,'FontName','Times New Roman')
set(gca,'FontSize',20)

%show time varience
figure(2)
% pic=[25,34,38,40,49];
% pic=[25,38,40,49];
pic=[42,40,38,36];
[Time2,Frequency2]=meshgrid(0.25:0.25:10,s1:e2);
for j=1:length(pic)
    for i=1:40   %calculate FFT under 1s with 10s
        FT2(:,i)=abs(fft(A(a1(i):a2(i),pic(j))))/gap_a;
    end
    FT2(FT2<1e-3)=1e-3;
    FT2(s1,1)=10^(6.1198/10);
    FT2(s1,2)=1e-3;
    subplot(1,4,j)
    mesh(Time2,4*Frequency2/1e3,10*log10(FT2(s1:e2,:)),'edgecolor','none','facecolor','interp')
    view(0,90)
%     xlim([0.25 10])
%     ylim([7.5 11.5])
    axis tight
    box on
    grid on
    set(gca,'FontName','Times New Roman')
    set(gca,'FontSize',16)
    if j==1
       ylabel('Frequency (kHz)')
    end
%     if j~=4
        xticks([0:2:10])
        xticklabels({'0','2','4','6','8','10'})
%     else
       xlabel('Time (s)')
%     end
end
mycolor2=[0.189950000000000,0.0717600000000000,0.232170000000000;0.191323629629630,0.0750336296296296,0.240423037037037;0.192697259259259,0.0783072592592593,0.248676074074074;0.194070888888889,0.0815808888888889,0.256929111111111;0.195425629629630,0.0848494814814815,0.265110370370370;0.196757037037037,0.0881118518518519,0.273202962962963;0.198088444444444,0.0913742222222222,0.281295555555556;0.199419851851852,0.0946365925925926,0.289388148148148;0.200716000000000,0.0978863703703704,0.297342222222222;0.202008000000000,0.101134666666667,0.305280000000000;0.203300000000000,0.104382962962963,0.313217777777778;0.204578518518519,0.107627407407407,0.321100666666667;0.205831111111111,0.110864444444444,0.328878000000000;0.207083703703704,0.114101481481482,0.336655333333333;0.208336296296296,0.117338518518519,0.344432666666667;0.209557777777778,0.120564444444444,0.352085555555556;0.210770962962963,0.123787407407407,0.359705259259259;0.211984148148148,0.127010370370370,0.367324962962963;0.213188000000000,0.130230000000000,0.374906666666667;0.214361777777778,0.133438888888889,0.382365925925926;0.215535555555556,0.136647777777778,0.389825185185185;0.216709333333333,0.139856666666667,0.397284444444445;0.217856148148148,0.143057851851852,0.404635851851852;0.218990518518519,0.146255481481482,0.411937481481482;0.220124888888889,0.149453111111111,0.419239111111111;0.221254074074074,0.152648888888889,0.426520000000000;0.222349037037037,0.155832444444444,0.433664000000000;0.223444000000000,0.159016000000000,0.440808000000000;0.224538962962963,0.162199555555556,0.447952000000000;0.225611111111111,0.165376592592593,0.455004740740741;0.226666666666667,0.168548888888889,0.461991111111111;0.227722222222222,0.171721185185185,0.468977481481482;0.228776740740741,0.174893111111111,0.475959703703704;0.229792888888889,0.178051333333333,0.482788444444445;0.230809037037037,0.181209555555556,0.489617185185185;0.231825185185185,0.184367777777778,0.496445925925926;0.232821333333333,0.187519333333333,0.503198666666667;0.233795259259259,0.190663481481482,0.509866962962963;0.234769185185185,0.193807629629630,0.516535259259259;0.235743111111111,0.196951777777778,0.523203555555556;0.236683333333333,0.200085555555556,0.529726666666667;0.237620666666667,0.203218444444445,0.536237333333334;0.238558000000000,0.206351333333333,0.542748000000000;0.239480814814815,0.209479037037037,0.549199555555556;0.240378740740741,0.212597851851852,0.555549777777778;0.241276666666667,0.215716666666667,0.561900000000000;0.242174592592593,0.218835481481482,0.568250222222222;0.243040370370370,0.221942814814815,0.574471851851852;0.243898888888889,0.225047555555556,0.580664444444445;0.244757407407407,0.228152296296296,0.586857037037037;0.245605555555556,0.231254074074074,0.593008148148148;0.246424666666667,0.234347555555556,0.599043111111111;0.247243777777778,0.237441037037037,0.605078074074074;0.248062888888889,0.240534518518519,0.611113037037037;0.248854000000000,0.243618000000000,0.617036000000000;0.249633703703704,0.246697407407407,0.622913333333333;0.250413407407407,0.249776814814815,0.628790666666667;0.251186444444445,0.252854444444445,0.634643111111111;0.251923925925926,0.255922592592593,0.640362814814815;0.252661407407407,0.258990740740741,0.646082518518519;0.253398888888889,0.262058888888889,0.651802222222222;0.254114222222222,0.265118518518519,0.657424814814815;0.254815111111111,0.268172592592593,0.662984074074074;0.255516000000000,0.271226666666667,0.668543333333334;0.256214814814815,0.274280000000000,0.674094296296297;0.256876296296296,0.277320000000000,0.679495925925926;0.257537777777778,0.280360000000000,0.684897555555556;0.258199259259259,0.283400000000000,0.690299185185185;0.258841037037037,0.286434370370370,0.695620592592593;0.259463111111111,0.289463111111111,0.700861777777778;0.260085185185185,0.292491851851852,0.706102962962963;0.260707259259259,0.295520592592593,0.711344148148148;0.261289333333333,0.298536000000000,0.716436000000000;0.261869185185185,0.301550666666667,0.721519555555556;0.262449037037037,0.304565333333333,0.726603111111111;0.263014444444444,0.307575555555556,0.731624444444445;0.263557703703704,0.310578962962963,0.736550370370371;0.264100962962963,0.313582370370371,0.741476296296296;0.264644222222222,0.316585777777778,0.746402222222222;0.265154296296296,0.319577333333334,0.751195407407408;0.265658148148148,0.322566666666667,0.755963703703704;0.266162000000000,0.325556000000000,0.760732000000000;0.266653629629630,0.328541259259259,0.765454666666667;0.267115259259259,0.331516518518519,0.770065333333334;0.267576888888889,0.334491777777778,0.774676000000000;0.268038518518519,0.337467037037037,0.779286666666667;0.268473185185185,0.340434000000000,0.783779111111111;0.268898222222222,0.343398000000000,0.788229333333333;0.269323259259259,0.346362000000000,0.792679555555556;0.269740518518519,0.349323407407408,0.797100740740741;0.270123333333333,0.352273333333333,0.801393333333334;0.270506148148148,0.355223259259259,0.805685925925926;0.270888962962963,0.358173185185185,0.809978518518519;0.271248666666667,0.361116000000000,0.814169777777778;0.271594888888889,0.364054666666667,0.818301925925926;0.271941111111111,0.366993333333333,0.822434074074074;0.272284000000000,0.369930666666667,0.826554000000000;0.272588000000000,0.372852444444445,0.830531333333334;0.272892000000000,0.375774222222222,0.834508666666667;0.273196000000000,0.378696000000000,0.838486000000000;0.273480740740741,0.381613333333333,0.842378888888889;0.273748148148148,0.384526666666667,0.846195777777778;0.274015555555556,0.387440000000000,0.850012666666667;0.274282962962963,0.390353333333334,0.853829555555556;0.274509259259259,0.393250222222222,0.857490222222222;0.274734444444444,0.396146666666667,0.861146666666667;0.274959629629630,0.399043111111111,0.864803111111111;0.275169407407407,0.401934814814815,0.868394370370371;0.275358000000000,0.404820000000000,0.871896000000000;0.275546592592593,0.407705185185185,0.875397629629630;0.275735185185185,0.410590370370371,0.878899259259260;0.275887111111111,0.413465777777778,0.882261555555556;0.276033481481482,0.416339703703704,0.885602740740741;0.276179851851852,0.419213629629630,0.888943925925926;0.276314666666667,0.422083111111111,0.892235333333333;0.276424444444445,0.424942962962963,0.895418888888889;0.276534222222222,0.427802814814815,0.898602444444445;0.276644000000000,0.430662666666667,0.901786000000000;0.276721555555556,0.433511777777778,0.904847111111111;0.276789111111111,0.436357555555555,0.907870222222222;0.276856666666667,0.439203333333333,0.910893333333333;0.276915925925926,0.442046740740741,0.913883851851852;0.276944074074074,0.444881259259259,0.916752148148148;0.276972222222222,0.447715777777778,0.919620444444444;0.277000370370370,0.450550296296296,0.922488740740741;0.277004444444444,0.453373703703703,0.925251481481481;0.276996000000000,0.456191333333333,0.927959333333333;0.276987555555556,0.459008962962963,0.930667185185185;0.276974666666667,0.461825703703703,0.933358148148148;0.276924000000000,0.464634888888888,0.935905555555555;0.276873333333333,0.467444074074074,0.938452962962963;0.276822666666667,0.470253259259259,0.941000370370370;0.276750222222222,0.473054666666666,0.943462222222222;0.276660148148148,0.475849777777777,0.945854814814814;0.276800000000000,0.471510000000000,0.942140000000000;0.276119256198347,0.489360330578512,0.956997107438017;0.274983553719008,0.507056363636364,0.970048512396694;0.273372644628099,0.524622148760331,0.981265867768595;0.270588925619835,0.542174793388430,0.990070661157025;0.265891900826446,0.559871652892562,0.995845702479339;0.259361322314050,0.577696280991735,0.998564214876033;0.251320578512397,0.595572892561983,0.998586942148760;0.241984876033058,0.613477438016529,0.996093966942149;0.231564958677686,0.631357272727273,0.991265785123967;0.220281404958678,0.649172809917355,0.984281157024794;0.208305454545455,0.666878181818182,0.975204545454546;0.195902148760331,0.684432396694215,0.964344462809918;0.183291157024793,0.701783636363636,0.951873636363637;0.170681404958678,0.718897520661157,0.937980247933885;0.158273636363636,0.735738347107438,0.922829586776860;0.146325041322314,0.752232396694215,0.906556694214876;0.135041157024793,0.768354958677686,0.889407438016529;0.124629256198347,0.784061570247934,0.871563801652893;0.115297768595041,0.799318347107438,0.853197272727273;0.107254049586777,0.814073140495868,0.834493884297521;0.100807107438016,0.828264049586777,0.815622231404958;0.0961127272727272,0.841855454545455,0.796782727272727;0.0933757851239669,0.854816115702480,0.778154710743801;0.0927970247933885,0.867114628099174,0.759920082644628;0.0945971900826447,0.878692066115703,0.742257851239669;0.0991152066115704,0.889479834710744,0.725379338842975;0.106469090909091,0.899493884297521,0.709191900826446;0.116596198347108,0.909050661157025,0.692087355371900;0.129296115702480,0.918239752066116,0.673614628099173;0.144372148760331,0.927033553719009,0.653914710743801;0.161708347107439,0.935408677685951,0.633111983471073;0.181043223140497,0.943343966942149,0.611382066115701;0.202126363636365,0.950841818181819,0.588900909090908;0.224768512396696,0.957875619834711,0.565809421487602;0.248770082644630,0.964427851239670,0.542265206611569;0.273979173553721,0.970460578512397,0.518395785123965;0.300145619834713,0.975973801652893,0.494390165289255;0.327053057851242,0.980943305785124,0.470389256198345;0.354497438016531,0.985365041322314,0.446544958677684;0.382295454545457,0.989214958677686,0.423008429752064;0.410239090909093,0.992455206611571,0.399941983471073;0.438109173553721,0.995073636363637,0.377516115702477;0.465705041322316,0.997063388429752,0.355855454545453;0.492834545454548,0.998419090909091,0.335119090909089;0.519285867768598,0.999106694214876,0.315445702479337;0.544840743801655,0.999084876033058,0.297049669421486;0.569280000000003,0.998350495867769,0.280056280991734;0.592427768595044,0.996905867768595,0.264602561983470;0.614097355371903,0.994724132231405,0.250830247933883;0.634088677685952,0.991788016528925,0.238889834710743;0.652745950413225,0.988009173553719,0.228952809917354;0.671372727272729,0.983333057851239,0.220887603305784;0.689967190082646,0.977796033057851,0.214518181818181;0.708491983471076,0.971450826446280,0.209692314049586;0.726881818181820,0.964311818181818,0.206276363636363;0.745088099173555,0.956413471074380,0.204165289256198;0.763049669421489,0.947780578512396,0.203207851239669;0.780729834710745,0.938482066115702,0.203228925619835;0.798063471074381,0.928545206611570,0.204077190082645;0.815015371900827,0.918007024793388,0.205630082644628;0.831509504132232,0.906890826446280,0.207756033057851;0.847490743801654,0.895237685950413,0.210299669421488;0.862919752066116,0.883086611570247,0.213111652892562;0.877749338842976,0.870486694214876,0.216051487603306;0.891934380165290,0.857466033057851,0.218969752066116;0.905381818181819,0.844051818181818,0.221743636363636;0.918052809917356,0.830287272727272,0.224189752066116;0.929913719008265,0.816207190082644,0.226197024793389;0.940911487603306,0.801861900826446,0.227615867768595;0.950992809917356,0.787283553719008,0.228315785123967;0.960085867768595,0.772490991735537,0.228130661157025;0.968118595041322,0.757530661157025,0.226885702479339;0.975083553719008,0.742446446280992,0.224490495867769;0.980931487603306,0.727228099173554,0.220826776859504;0.985777603305785,0.711359504132232,0.216138016528926;0.989707520661157,0.694525123966942,0.210664297520661;0.992728181818182,0.676807272727273,0.204456363636364;0.994893057851240,0.658332727272728,0.197626033057851;0.996225371900826,0.639186528925620,0.190238429752066;0.996746033057851,0.619454297520662,0.182368347107438;0.996458512396694,0.599207768595042,0.174068099173554;0.995370991735537,0.578541900826447,0.165407933884298;0.993534628099174,0.557564132231406,0.156488677685951;0.990967520661157,0.536354876033059,0.147365123966943;0.987696363636364,0.515000909090910,0.138105041322315;0.983733057851240,0.493597272727274,0.128789669421488;0.979064297520662,0.472233388429754,0.119489421487604;0.973753636363637,0.450990909090911,0.110279090909092;0.967828595041323,0.429970495867770,0.101218347107439;0.961295785123968,0.409241570247936,0.0923874380165296;0.954179834710744,0.388916363636365,0.0838525619834718;0.946468429752067,0.369084958677688,0.0757108264462817;0.938226446280993,0.349829338842977,0.0680120661157032;0.929466033057852,0.331234297520663,0.0608260330578519;0.920213057851241,0.313384132231407,0.0542145454545461;0.910466446280993,0.296374710743803,0.0482722314049593;0.900258099173555,0.280329917355374,0.0430842975206617;0.889568760330580,0.265151157024795,0.0385812396694220;0.878318181818183,0.250401818181820,0.0343954545454550;0.866474380165291,0.236002479338845,0.0304778512396699;0.854031074380167,0.221956198347109,0.0268354545454550;0.840963140495870,0.208282479338845,0.0234711570247938;0.827311983471076,0.194957190082646,0.0203690909090913;0.813071322314052,0.181983223140498,0.0175358677685954;0.798241735537192,0.169357685950415,0.0149691735537194;0.782814462809920,0.157097355371903,0.0126704958677689;0.766770495867771,0.145199338842977,0.0106487603305788;0.750127768595044,0.133648016528927,0.00889355371900853;0.732903388429755,0.122450991735539,0.00740867768595064;0.715080000000003,0.111610909090911,0.00618454545454563;0.696670247933888,0.101115537190084,0.00522809917355387;0.677642727272731,0.0909947107438035,0.00455876033057862;0.658011983471078,0.0812266115702497,0.00414611570247939;0.637798016528930,0.0718112396694232,0.00401000000000000;0.616992727272731,0.0627404958677703,0.00413231404958672;0.595598842975211,0.0540295867768612,0.00452785123966933;0.573577520661162,0.0456842148760347,0.00520115702479323;0.550968925619840,0.0376915702479355,0.00614107438016507;0.527769173553724,0.0300516528925636,0.00734752066115674;0.503976198347113,0.0227644628099189,0.00881247933884262;0.479600000000005,0.0158300000000015,0.0105499999999996];
colormap(mycolor2)
% colormap(jet)


% dotNum=64;
% time=linspace(0,10,length(A(:,1)));
% subplot(2,5,1)
% [c,lags] = xcorr(A(1:dotNum:end,25),A(1:dotNum:end,25),'normalized');
% plot(lags*(time(2)-time(1))*dotNum,c,'.','MarkerSize',3)
% grid on
% box on
% xlim([-10 10])
% xticks([-10:5:10])
% yticks([-1:0.5:1])
% % xlabel('Time (s)')
% ylabel('Correlation')
% set(gca,'FontName','Times New Roman')
% set(gca,'FontSize',16)
% subplot(2,5,2)
% [c,lags] = xcorr(A(1:dotNum:end,34),A(1:dotNum:end,34),'normalized');
% plot(lags*(time(2)-time(1))*dotNum,c,'.','MarkerSize',3)
% grid on
% box on
% xlim([-10 10])
% xticks([-10:5:10])
% yticks([-1:0.5:1])
% yticklabels({''})
% % xlabel('Time (s)')
% set(gca,'FontName','Times New Roman')
% set(gca,'FontSize',16)
% subplot(2,5,3)
% [c,lags] = xcorr(A(1:dotNum:end,38),A(1:dotNum:end,38),'normalized');
% plot(lags*(time(2)-time(1))*dotNum,c,'.','MarkerSize',3)
% grid on
% box on
% xlim([-10 10])
% xticks([-10:5:10])
% yticks([-1:0.5:1])
% yticklabels({''})
% % xlabel('Time (s)')
% set(gca,'FontName','Times New Roman')
% set(gca,'FontSize',16)
% subplot(2,5,4)
% [c,lags] = xcorr(A(1:dotNum:end,40),A(1:dotNum:end,40),'normalized');
% plot(lags*(time(2)-time(1))*dotNum,c,'.','MarkerSize',3)
% grid on
% box on
% xlim([-10 10])
% xticks([-10:5:10])
% yticks([-1:0.5:1])
% yticklabels({''})
% % xlabel('Time (s)')
% set(gca,'FontName','Times New Roman')
% set(gca,'FontSize',16)
% subplot(2,5,5)
% [c,lags] = xcorr(A(1:dotNum:end,49),A(1:dotNum:end,49),'normalized');
% plot(lags*(time(2)-time(1))*dotNum,c,'.','MarkerSize',3)
% grid on
% box on
% xlim([-10 10])
% xticks([-10:5:10])
% yticks([-1:0.5:1])
% yticklabels({''})
% % xlabel('Time (s)')
% set(gca,'FontName','Times New Roman')
% set(gca,'FontSize',16)

% stop

figure(4)
eDim=2:30;
colorline=jet(length(eDim));
pic=23:58;%[25,34,38,40,49];
for j=1:length(pic)
    parfor i=1:eDim(end-1)
%     [~,rRange,corInt(:,i,j)]=correlationDimension(A(1:128:5*1024*1024,pic(j)),eLag,eDim(i),'MinRadius',1e-1,'MaxRadius',1e2,'NumPoints',200);
%     subplot(2,5,j)
%     hold on
%     plot(log(rRange),medfilt1(log(corInt(:,i,j)/2)),'linewidth',1,'color',colorline(i,:))
%     xlim([2 4])
%     xticklabels('{}')
%     ylim([-12 0])
%     if j==1
%         ylabel('ln(C_D)')
%     end
%     set(gca,'FontName','Times New Roman')
%     set(gca,'FontSize',16)
%     grid on
%     box on
%     subplot(2,5,5+j)
%     hold on
%     plot(log(rRange),gradient(medfilt1(log(corInt(:,i,j)/2)),log(rRange)),'linewidth',1,'color',colorline(i,:))

x=log(rRange(140:168));
y=medfilt1(log(corInt(140:168,i,j)/2));
p = polyfit(x(2:end),y(2:end),1);
dot(i,j)=p(1);
% x1 = linspace(x(2),x(end));
% y1 = polyval(p,x1);
% plot(x(2:end),y(2:end),'o')
% hold on
% plot(x1,y1,'linewidth',2)
% hold off
    
%     xlim([2 4])
%     ylim([0 8])
%     yticks([0 1 4 7])
%     grid on
%     box on
%     xlabel('ln(r)')
%     if j==1
%         ylabel('\nabla[ln(C_D)]')
%     end
%     set(gca,'FontName','Times New Roman')
%     set(gca,'FontSize',16)
    end
end
figure(1)
subplot(313)
dot=dot';
mycolor=jet(35);
hold on
for i=2:29
    plot(temp(2:36),dot(2:36,i),'s','MarkerFace',mycolor(i-1,1:3),'color',mycolor(i-1,1:3))
end
grid on
box on
xlim([22.3 24])
ylim([1 3.5])
xlabel('T (C^o)')
ylabel('D_2')
set(gca,'FontName','Times New Roman','FontSize',20)
% 
% Dot=zeros(175,36);
% for i=2:36
%     for j=2:29
%         Dot(round(dot(i,j)*5e1),i)=Dot(round(dot(i,j)*5e1),i)+1;
%     end
% end
% [Temp,nu]=meshgrid(temp,1:175);
% mesh(Temp,nu,Dot/max(Dot(:)),'facecolor','interp','EdgeColor','none')
% set(gca,'YDir','Normal')
% ylim([49 175])
% colormap(turbo)
% view(0,90)